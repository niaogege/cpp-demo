<!--
 * @Author: Chendapeng
 * @Date: 2021-12-29 16:38:16
 * @LastEditors: Chendapeng
 * @LastEditTime: 2021-12-30 08:30:57
 * @Description: https相关的面试题记录
-->

https握手过程

（SSL的加密过程是RSA与AES混合进行的。简单概括一下，就是通过RSA加密方式来交换AES加解密的密钥，然后使用AES加密的方式来传输报文。）

RSA: 非对称加密算法 身份验证 和 密钥协商，

AES: 对称加密算法 信息加密


### First Step

客户端发起第一次握手，主要目的是从服务端获取数字签名证书，服务端在发送数字签名证书之前要先确认客户端的ssl版本以及可支持的加密套件
(客户端本地有个证书管理器, 有"受信任的根证书颁发机构"列表,客户端根据这个列表查找解开数字证书的公钥是否在列表之内，如果数字证书记载的网址跟你正在浏览的不一样则会发出警告)


### Second Step

完成第一次握手后，接着进行第二次握手。第二次握手是在客户端收到证书后发起的，主要目的是将 AES加解密使用的Key （Pre-master secret）发送给服务端。当然这个AES_KEY是使用第一次握手获取的公钥进行加密的。客户端收到这个使用公钥加密后的AES_KEY，使用服务端的私钥进行解密。这样客户端和服务端经过二次握手后都持有了AES加解密的KEY。———第二步进行数字签名验证

服务端需要验证CA证书
服务器收到后用公开密钥（当然应用了私有密钥）得到报文摘要C。然后自己再用同样的签名函数对明文得到报文摘要D。如果C==D，说明验证成功

当客户端收到证书后，会对此证书进行辨别真伪。提前说明一下：当今的浏览器对各大证书颁发机构的名称和对应的机构公钥都进行了存储。所以客户端收到证书后，只需要从浏览器本地找到对应的机构公钥，对证书签名进行解密，然后客户端根据这个解密后的签名规则，自己也生成一个证书签名，如果两个签名一致，则通过。通过之后，客户端再次使用机构公钥解密出服务端公钥key1


数字证书需要向有权威的认证机构(CA)获取授权给服务器。首先，服务器和CA机构分别有一对密钥(公钥和私钥)，然后是如何生成数字证书的呢？

CA机构通过摘要算法生成服务器公钥的摘要(哈希摘要)
CA机构通过CA私钥及特定的签名算法加密摘要，生成签名
把签名、服务器公钥等信息打包放入数字证书，并返回给服务器

服务器配置好证书，以后客户端连接服务器，都先把证书发给客户端验证并获取服务器的公钥。



### Third Step

当Client与Server端都持有AES_KEY后，就可以对HTTP报文进行加解密了。这里就不再是RSA了，而是使用对称加密，就算被第三方劫持，第三方也不知道密码。除非其中一个人把密码告诉第三方。这里使用对称加密也是为了提高HTTPS的性能。因为本身HTTPS所消耗的时间也是不可忽视的。



## https握手Tls1.2版本last总结

1.客户端向服务发送信息(tls版本/加密套件/第一个随机数)
2.服务端打招呼，并确认服务端支持的Tls版本以及选择的加密套件，以及服务端生成的第二个随机数，发给客户端
3.服务端把证书和公钥都发给客户端
4.客户端生成第三个随机数也就是预主密钥，客户端用刚刚收到的公钥加密预主密钥再发给服务端
5.服务端收到预主密钥之后，用自己的私钥进行解密，这样双方都知道预主密钥了 
6.客户端用预主密钥+第一个随机数+第二个随机数通过 ECDHE算法 生成会话密钥，服务端用同样的道理生成会话密钥，这之前都是非对称加密，之后用的都是对称加密
7.会话之后都用这个私钥进行传输信息，也就是对称加密 


在TLS1.3版本中废弃了RSA算法，因为RSA算法可能泄露私钥导致历史报文全部被破解，而ECDHE算法每次握手都会生成临时的密钥，所以就算私钥被破解，也只能破解一条报文，而不会对之前的历史信息产生影响，，所以在TLS 1.3中彻底取代了RSA。目前主流都是用ECDHE算法来做密钥交换的



### 参考文档
- [20分钟助你拿下HTTP和HTTPS，巩固你的HTTP知识体系3](https://juejin.cn/post/6994629873985650696#heading-12)